<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>å¥½çŸ¥è­˜é‡åŒ–å›æ¸¬èˆ‡æ•¸æ“šä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f6f9;
      }
      .container {
        max-width: 1400px;
        margin: auto;
      }

      /* ä½ˆå±€ */
      .control-panel {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
      }
      .main-content {
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 20px;
      }
      .chart-section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        min-height: 500px;
      }
      .log-section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        max-height: 600px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      /* ã€æ–°å¢ã€‘æ’è¡Œæ¦œå€å¡Šæ¨£å¼ */
      .leaderboard-section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-top: 20px;
      }

      /* è¼¸å…¥å…ƒä»¶ */
      label {
        font-weight: 600;
        color: #555;
        font-size: 0.9em;
        margin-right: 5px;
      }
      input,
      select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        outline: none;
        font-size: 0.95em;
      }
      input:focus,
      select:focus {
        border-color: #007bff;
      }

      /* æŒ‰éˆ• */
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
        color: white;
      }
      .btn-run {
        background: #007bff;
      }
      .btn-run:hover {
        background: #0056b3;
      }
      .btn-update {
        background: #6c757d;
      }
      .btn-update:hover {
        background: #545b62;
      }

      /* MACD åƒæ•¸å€ - è—è‰²é¢¨æ ¼ */
      .macd-params {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #eef6fc;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #dbe9f5;
      }
      .macd-params input {
        width: 45px;
        text-align: center;
        border: 1px solid #bbd6ee;
        color: #0056b3;
        font-weight: bold;
      }
      .macd-params select {
        max-width: 200px;
        border: 1px solid #bbd6ee;
        color: #333;
      }

      /* çµæœé¡¯ç¤º */
      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .stat-item {
        text-align: right;
      }
      .stat-val {
        font-size: 1.4em;
        font-weight: bold;
        color: #28a745;
      }

      /* è¡¨æ ¼ */
      .log-list {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 6px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
      }
      th {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        padding: 8px;
        text-align: center; /* çµ±ä¸€ç½®ä¸­ */
        font-size: 0.85em;
        color: #666;
      }
      td {
        padding: 8px;
        border-bottom: 1px solid #f1f1f1;
        text-align: center; /* çµ±ä¸€ç½®ä¸­ */
      }
      .buy {
        color: #d9534f;
        font-weight: bold;
      }
      .sell {
        color: #28a745;
        font-weight: bold;
      }

      @media (max-width: 1000px) {
        .main-content {
          grid-template-columns: 1fr;
        }
        .log-section {
          max-height: 400px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="container">
      <div class="control-panel">
        <div>
          <label>è‚¡ç¥¨</label
          ><input v-model="symbol" style="width: 80px" placeholder="0050" />
        </div>
        <div>
          <label>æœ¬é‡‘</label
          ><input
            type="number"
            v-model.number="backtestParams.init_cash"
            style="width: 100px"
          />
        </div>
        <div>
          <label>å€é–“</label>
          <input type="date" v-model="backtestParams.start_date" /> ~
          <input type="date" v-model="backtestParams.end_date" />
        </div>
        <div>
          <label>ç­–ç•¥</label>
          <select v-model="selectedStrategy">
            <option value="macd">MACD è¶¨å‹¢</option>
            <option value="default_kd">KD åè½‰</option>
            <option value="trend_kd">KD + è¶¨å‹¢</option>
          </select>
        </div>

        <div v-if="selectedStrategy === 'macd'" class="macd-params">
          <select v-model="selectedTemplate" @change="applyTemplate">
            <option :value="-1" disabled>è«‹é¸æ“‡åƒæ•¸æ¨¡æ¿...</option>
            <option v-for="(t, index) in macdTemplates" :value="index">
              [[ t.name ]] ([[ t.vals.join(',') ]])
            </option>
          </select>

          <input
            type="number"
            v-model.number="backtestParams.m1"
            title="å¿«ç·š (Fast)"
          />
          <input
            type="number"
            v-model.number="backtestParams.m2"
            title="æ…¢ç·š (Slow)"
          />
          <input
            type="number"
            v-model.number="backtestParams.m3"
            title="è¨Šè™Ÿ (Signal)"
          />
        </div>

        <div style="margin-left: auto; display: flex; gap: 10px">
          <button class="btn-run" @click="runBacktest" :disabled="loading">
            [[ loading ? 'é‹ç®—ä¸­...' : 'åŸ·è¡Œå›æ¸¬' ]]
          </button>
          <button
            class="btn-update"
            @click="updateStockData"
            :disabled="updating"
          >
            æ›´æ–°/é‡æŠ“è³‡æ–™
          </button>
        </div>
      </div>

      <div class="main-content" v-if="backtestResult">
        <div class="chart-section">
          <div class="result-header">
            <div>
              <div style="font-size: 1.2em; font-weight: bold">
                [[ backtestResult.symbol ]] å›æ¸¬çµæœ
              </div>
              <div style="color: #888; font-size: 0.9em">
                [[ backtestResult.start_date ]] ~ [[ backtestResult.end_date ]]
                <span
                  v-if="selectedStrategy === 'macd'"
                  style="
                    margin-left: 10px;
                    background: #eef6fc;
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 0.85em;
                  "
                >
                  åƒæ•¸: [[ backtestParams.m1 ]], [[ backtestParams.m2 ]], [[
                  backtestParams.m3 ]]
                </span>
              </div>
            </div>
            <div class="stat-item">
              <div style="color: #666; font-size: 0.9em">ç¸½å ±é…¬ç‡</div>
              <div
                class="stat-val"
                :style="{ color: backtestResult.total_return_pct >= 0 ? '#d9534f' : '#28a745' }"
              >
                [[ backtestResult.total_return_pct ]]%
              </div>
              <div style="font-size: 0.9em; font-weight: bold">
                $[[ backtestResult.final_value.toLocaleString() ]]
              </div>
            </div>
          </div>
          <div id="main-chart" style="width: 100%; height: 450px"></div>
        </div>

        <div class="log-section">
          <h4 style="margin-top: 0; margin-bottom: 10px">ğŸ“œ æ¨¡æ“¬äº¤æ˜“ç´€éŒ„</h4>
          <div class="log-list">
            <table>
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>å‹•ä½œ</th>
                  <th>è‚¡æ•¸</th>
                  <th>åƒ¹æ ¼</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="(log, index) in backtestResult.trade_log"
                  :key="index"
                >
                  <td>[[ log.date ]]</td>
                  <td :class="log.action === 'è²·å…¥' ? 'buy' : 'sell'">
                    [[ log.action ]]
                  </td>
                  <td>[[ log.size ]]</td>
                  <td>$[[ log.price ]]</td>
                </tr>
                <tr v-if="backtestResult.trade_log.length === 0">
                  <td
                    colspan="4"
                    style="text-align: center; color: #999; padding: 20px"
                  >
                    ç„¡äº¤æ˜“è¨Šè™Ÿ
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div v-else style="text-align: center; padding: 50px; color: #999">
        è«‹é»æ“Šã€ŒåŸ·è¡Œå›æ¸¬ã€ä»¥æŸ¥çœ‹çµæœ
      </div>

      <div class="leaderboard-section">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
          "
        >
          <h3 style="margin: 0">
            ğŸ† 0050 ç­–ç•¥ç«¶æŠ€å ´ (å³æ™‚æ’å)
            <span
              v-if="leaderboardDate"
              style="font-size: 0.6em; color: #888; margin-left: 10px"
              >æ•¸æ“šæ—¥æœŸ: [[ leaderboardDate ]]</span
            >
          </h3>
          <button
            @click="fetchLeaderboard"
            style="padding: 5px 15px; font-size: 0.9em; background: #6610f2"
          >
            ğŸ”„ åˆ·æ–°æˆ°æ³
          </button>
        </div>

        <table>
          <thead>
            <tr style="background: #f8f9fa; color: #666">
              <th style="padding: 10px">æ’å</th>
              <th>ç­–ç•¥åƒæ•¸</th>
              <th>ç›®å‰å‹•ä½œ</th>
              <th>æŒæœ‰è‚¡æ•¸</th>
              <th>ç¸½è³‡ç”¢</th>
              <th>å ±é…¬ç‡ (ROI)</th>
            </tr>
          </thead>
          <tbody>
            <tr
              v-for="(item, index) in leaderboard"
              :key="index"
              style="border-bottom: 1px solid #eee; text-align: center"
            >
              <td style="padding: 12px; font-weight: bold">
                <span v-if="index === 0">ğŸ‘‘</span>
                <span v-else>#[[ index + 1 ]]</span>
              </td>
              <td>[[ item.strategy ]]</td>
              <td>
                <span
                  v-if="item.action === 'BUY'"
                  style="
                    color: white;
                    background: #d9534f;
                    padding: 3px 8px;
                    border-radius: 4px;
                    font-size: 0.8em;
                  "
                  >è²·é€²</span
                >
                <span
                  v-else-if="item.action === 'SELL'"
                  style="
                    color: white;
                    background: #28a745;
                    padding: 3px 8px;
                    border-radius: 4px;
                    font-size: 0.8em;
                  "
                  >è³£å‡º</span
                >
                <span
                  v-else-if="item.shares > 0"
                  style="
                    color: white;
                    background: #007bff;
                    padding: 3px 8px;
                    border-radius: 4px;
                    font-size: 0.8em;
                  "
                  >æŒå€‰ä¸­</span
                >
                <span v-else style="color: #999">ç©ºæ‰‹</span>
              </td>
              <td>[[ item.shares ]]</td>
              <td>$[[ item.assets.toLocaleString() ]]</td>
              <td
                :style="{ color: item.roi >= 0 ? '#d9534f' : '#28a745', fontWeight: 'bold' }"
              >
                [[ item.roi ]]%
              </td>
            </tr>
            <tr v-if="leaderboard.length === 0">
              <td colspan="6" style="padding: 20px; color: #999">
                ç›®å‰ç„¡è³‡æ–™ï¼Œè«‹åŸ·è¡Œå¾Œå° python monitor_top10.py
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      new Vue({
        el: "#app",
        delimiters: ["[[", "]]"],
        data: {
          symbol: "0050",
          selectedStrategy: "macd",
          selectedTemplate: 0,
          loading: false,
          updating: false,
          backtestResult: null,
          myChart: null,
          // æ’è¡Œæ¦œè³‡æ–™
          leaderboard: [],
          leaderboardDate: "",
          // MACD åƒæ•¸æ¨¡æ¿
          macdTemplates: [
            {
              name: "æ¨™æº–åƒæ•¸ (é€šç”¨å‹)",
              vals: [12, 26, 9],
              desc: "æœ€ç¶“å…¸è¨­å®š",
            },
            {
              name: "DiNapoli (çŸ­ç·šéˆæ•)",
              vals: [8, 17, 9],
              desc: "åæ‡‰æ›´å¿«",
            },
            {
              name: "è¶…çŸ­ç·š (é«˜é »ç•¶æ²–)",
              vals: [6, 13, 4],
              desc: "æ¥µåº¦æ•æ„Ÿ",
            },
            {
              name: "é•·ç·šè¶¨å‹¢ (å¤§æ³¢æ®µ)",
              vals: [19, 39, 9],
              desc: "éæ¿¾é›œè¨Š",
            },
            {
              name: "é›™å€é€±æœŸ (ç©©å¥å‹)",
              vals: [24, 52, 18],
              desc: "å¹³æ»‘ç©©å®š",
            },
            {
              name: "Linda Raschke (åè½‰)",
              vals: [3, 10, 16],
              desc: "å°ˆæŠ“åè½‰",
            },
            {
              name: "ä¿å®ˆè¨Šè™Ÿ (å°‘äº¤æ˜“)",
              vals: [12, 26, 15],
              desc: "ç¢ºèªæ‰é€²å ´",
            },
            {
              name: "åŠ å¯†è²¨å¹£å‹ (é«˜æ³¢)",
              vals: [10, 20, 5],
              desc: "å¹£åœˆå¸¸ç”¨",
            },
            {
              name: "æœˆç·šç´šåˆ¥ (è¶…é•·ç·š)",
              vals: [5, 35, 5],
              desc: "çœ‹é•·ç·š",
            },
            {
              name: "æ‰‹è¡“åˆ€ (æ¥µè‡´å‰é ­çš®)",
              vals: [5, 15, 3],
              desc: "å¿«é€²å¿«å‡º",
            },
          ],
          backtestParams: {
            init_cash: 1000000,
            start_date: "2015-01-01",
            end_date: "2026-02-06",
            m1: 12,
            m2: 26,
            m3: 9,
            k_period: 9,
            ma_period: 200,
          },
        },
        // ã€æ–°å¢ã€‘ç¶²é è¼‰å…¥æ™‚è‡ªå‹•æŠ“å–æ’è¡Œæ¦œ
        created() {
          this.fetchLeaderboard();
        },
        mounted() {
          /* ECharts init later */
        },
        methods: {
          applyTemplate() {
            const t = this.macdTemplates[this.selectedTemplate];
            this.backtestParams.m1 = t.vals[0];
            this.backtestParams.m2 = t.vals[1];
            this.backtestParams.m3 = t.vals[2];
          },
          async updateStockData() {
            if (!confirm("ç¢ºå®šè¦é‡æŠ“è³‡æ–™å—ï¼Ÿ")) return;
            this.updating = true;
            try {
              await fetch("/api/update-stock/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ symbol: this.symbol }),
              });
              alert("æ›´æ–°å®Œæˆï¼");
            } catch (e) {
              alert("æ›´æ–°å¤±æ•—");
            } finally {
              this.updating = false;
            }
          },
          async runBacktest() {
            this.loading = true;
            try {
              const res = await fetch("/api/run-backtest/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  symbol: this.symbol,
                  strategy: this.selectedStrategy,
                  params: this.backtestParams,
                }),
              });
              const data = await res.json();
              if (data.error) {
                alert(data.error);
                return;
              }
              this.backtestResult = data;
              this.$nextTick(() => {
                this.renderChart(data.chart_data);
              });
            } catch (e) {
              alert("API é€£ç·šéŒ¯èª¤");
            } finally {
              this.loading = false;
            }
          },
          // ã€æ–°å¢ã€‘æŠ“å–æ’è¡Œæ¦œè³‡æ–™
          async fetchLeaderboard() {
            try {
              const res = await fetch("/api/leaderboard/");
              const data = await res.json();
              if (data.rankings) {
                this.leaderboard = data.rankings;
                this.leaderboardDate = data.date;
              }
            } catch (e) {
              console.error("ç„¡æ³•å–å¾—æ’è¡Œæ¦œ:", e);
            }
          },
          renderChart(chartData) {
            if (!this.myChart) {
              this.myChart = echarts.init(
                document.getElementById("main-chart"),
              );
              window.onresize = () => this.myChart.resize();
            }
            const option = {
              tooltip: { trigger: "axis", axisPointer: { type: "cross" } },
              legend: { data: ["ç¸½è³‡ç”¢", "è‚¡åƒ¹"], bottom: 0 },
              grid: {
                left: "3%",
                right: "3%",
                bottom: "10%",
                containLabel: true,
              },
              xAxis: { type: "category", data: chartData.dates },
              yAxis: [
                {
                  type: "value",
                  name: "è³‡ç”¢",
                  position: "left",
                  scale: true,
                  axisLine: { show: true, lineStyle: { color: "#5470C6" } },
                },
                {
                  type: "value",
                  name: "è‚¡åƒ¹",
                  position: "right",
                  scale: true,
                  splitLine: { show: false },
                  axisLine: { show: true, lineStyle: { color: "#91CC75" } },
                },
              ],
              series: [
                {
                  name: "ç¸½è³‡ç”¢",
                  type: "line",
                  yAxisIndex: 0,
                  data: chartData.values,
                  smooth: true,
                  itemStyle: { color: "#5470C6" },
                  areaStyle: { opacity: 0.1 },
                },
                {
                  name: "è‚¡åƒ¹",
                  type: "line",
                  yAxisIndex: 1,
                  data: chartData.prices,
                  smooth: true,
                  itemStyle: { color: "#91CC75" },
                  lineStyle: { type: "dashed" },
                },
              ],
            };
            this.myChart.setOption(option, true);
          },
        },
      });
    </script>
  </body>
</html>